<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>WW2 Film Timeline Test Site</title>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  background: #f4f4f4;
Â  Â  Â  margin: 20px;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  .controls {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 10px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 0 10px;
Â  Â  }
Â  Â  input[type="text"], select, button {
Â  Â  Â  padding: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 4px;
Â  Â  }


Â  Â  /* --- 1. UNIFIED PANEL CONTAINER STYLES (Cleaned and unified) --- */
Â  Â  .timeline-legend,Â 
Â  Â  .filter-panel,
Â  Â  details.config-panel,
Â  Â  details.stats-panel {
Â  Â  Â  Â  max-width: 900px;
Â  Â  Â  Â  margin: 0 auto 20px;
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Fix: Removes all outer padding for consistent width */
Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  font-size: 1em;Â 
Â  Â  }

Â  Â Â 
Â  Â  /* --- 2. UNIFIED SUMMARY STYLING (Fixed height and arrow removal) --- */
Â  Â  .timeline-legend summary,Â 
Â  Â  .filter-panel summary,
Â  Â  .config-panel summary,Â 
Â  Â  .stats-panel summary {Â 
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Fix: Sets consistent padding/height for the title bar */
Â  Â  Â  Â  padding: 10px 20px;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Fix: Removes the default browser arrow/marker */
Â  Â  Â  Â  list-style: none;
Â  Â  }

Â  Â Â 
Â  Â  /* --- 3a. UNIFIED ARROW ICON STYLING (CLOSED) --- */
Â  Â  .timeline-legend summary::before,Â 
Â  Â  .filter-panel summary::before,
Â  Â  .config-panel summary::before,Â 
Â  Â  .stats-panel summary::before {Â  Â 
Â  Â  Â  Â  content: 'â–¶';
Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  transition: transform 0.2s;
Â  Â  }

Â  Â  /* --- 3b. UNIFIED ARROW ICON STYLING (OPEN) --- */
Â  Â  .timeline-legend[open] summary::before,
Â  Â  .filter-panel[open] summary::before,
Â  Â  .config-panel[open] summary::before,Â 
Â  Â  .stats-panel[open] summary::before {Â  Â 
Â  Â  Â  Â  content: 'â–¼';
Â  Â  }

/* --- DEFINITIVE MOBILE FONT SCALING FIX FOR ANDROID CHROME --- */

/* 1. Target the summary elements to disable 'tap zoom' on all panels */
.timeline-legend summary, 
.filter-panel summary,
.config-panel summary, 
.stats-panel summary {
    /* Prevents the browser from zooming the area on tap/click */
    touch-action: manipulation; 
}


@media screen and (max-width: 768px) {
    /* 2. AGGRESSIVE ROOT RESET: Prevents global scaling initiated by complex content */
    html {
        font-size: 100% !important; 
        /* The single most important rule for Android Chrome scaling */
        -webkit-text-size-adjust: 100% !important; 
        text-size-adjust: 100% !important;
    }
    
    /* 3. LOCK THE TRIGGER: Aggressively lock the Stats content (the problem source) and its children */
    .controls#statsContent,
    .controls#statsContent * {
        font-size: 1em !important; 
        -webkit-text-size-adjust: none !important;
        text-size-adjust: none !important;
    }

    /* 4. LOCK ALL PANELS WHEN OPEN: Safety net to ensure all panels revert immediately */
    .timeline-legend[open], 
    .filter-panel[open],
    details.config-panel[open],
    details.stats-panel[open] {
        font-size: 1em !important; 
        zoom: 1 !important;
    }
    
    /* 5. LOCK ALL INNER CONTENT: Lock all content containers when open */
    .timeline-legend[open] .legend-content,
    .filter-panel[open] .controls,
    details.config-panel[open] .controls,
    details.stats-panel[open] .controls {
        font-size: 1em !important; 
    }
    
    /* 6. LOCK FORM ELEMENTS: Ensure inputs/selects in the controls areas revert to 14px */
    .filter-panel[open] .controls input, 
    .filter-panel[open] .controls select,
    .config-panel[open] .controls input, 
    .config-panel[open] .controls select {
        font-size: 14px !important;
    }
}


/* --- END OF MOBILE FIXES --- */
Â  Â Â 
.legend-content {
Â  Â  display: flex;
Â  Â  flex-wrap: wrap;
Â  Â  gap: 30px;
Â  Â Â 
Â  Â  /* Fix: Adds internal padding back to the legend content */
Â  Â  padding: 10px 20px 10px 20px;Â 
Â  Â Â 
Â  Â  border-top: 1px dashed #eee;
}

Â  Â Â 
Â  Â  .legend-group h3 {
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  margin-top: 0;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .legend-group table {
Â  Â  Â  width: 100%;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  font-size: 0.9em;
Â  Â  }
Â  Â  .legend-group td {
Â  Â  Â  padding: 4px 8px 4px 0;
Â  Â  Â  vertical-align: top;
Â  Â  }
Â  Â  .legend-box {
Â  Â  Â  width: 20px;
Â  Â  Â  padding: 0 !important;
Â  Â  Â  border-left: 5px solid;
Â  Â  Â  height: 1.2em;
Â  Â  Â  background: #f9f9f9;
Â  Â  }
Â  Â  .timeline {
Â  Â  Â  position: relative;
Â  Â  Â  max-width: 900px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 20px 0;
Â  Â  }
Â  Â  .timeline::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 50%;
Â  Â  Â  width: 4px;
Â  Â  Â  background: #555;
Â  Â  Â  transform: translateX(-50%);
Â  Â  }
Â  Â  .year-group {
Â  Â  Â  position: relative;
Â  Â  Â  margin-bottom: 80px;
Â  Â  Â  width: 100%;
Â  Â  Â  padding-top: 30px;
Â  Â  }
Â  Â  .year-group::after {
Â  Â  Â  content: "";
Â  Â  Â  display: table;
Â  Â  Â  clear: both;
Â  Â  }
Â  Â  .year-marker {
Â  Â  Â  position: absolute;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  font-size: 1.5em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #333;
Â  Â  Â  top: 0;
Â  Â  Â  background: #dcdcdc;
Â  Â  Â  padding: 4px 12px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  z-index: 10;
Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .timeline-event {
Â  Â  Â  position: relative;
Â  Â  Â  width: 45%;
Â  Â  Â  padding: 15px;
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s, background-color 0.2s;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 8px;
Â  Â  Â  border-left: 5px solid #ccc;
Â  Â  }
Â  Â  .timeline-event.left {
Â  Â  Â  float: left;
Â  Â  Â  clear: both;
Â  Â  Â  margin-right: auto;
Â  Â  }
Â  Â  .timeline-event.right {
Â  Â  Â  float: right;
Â  Â  Â  clear: both;
Â  Â  Â  margin-left: auto;
Â  Â  }
Â  Â  .timeline-event:hover {
Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  background-color: #eaf1f9;
Â  Â  }
Â  Â  .timeline-event.pinned {
Â  Â  Â  background-color: #fffbe6;
Â  Â  Â  box-shadow: inset 0 0 0 4px #f5b301;
Â  Â  }
Â  Â  .classification-Documentary { border-left-color: #1a8754; }
Â  Â  .classification-Dramatisation { border-left-color: #ffc107; }
Â  Â  .classification-Fiction { border-left-color: #dc3545; }
Â  Â  .timeline-event.watched {
Â  Â  Â  border-left-width: 5px;
Â  Â  Â  border-left-style: solid;
Â  Â  Â  box-shadow: inset 0 0 0 2px #0d6efd;
Â  Â  }
Â  Â  .event-title {
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  line-height: 1.3;
Â  Â  }
Â  Â  .event-image {
Â  Â  Â  max-width: 60px;
Â  Â  Â  height: auto;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  margin-right: 10px;
Â  Â  Â  float: left;
Â  Â  Â  object-fit: cover;
Â  Â  }
Â  Â  .event-details {
Â  Â  Â  margin-top: 5px;
Â  Â  Â  color: #555;
Â  Â  Â  font-size: 0.9em;
Â  Â  }
Â  Â  .notes {
Â  Â  Â  display: none;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  padding-top: 10px;
Â  Â  Â  border-top: 1px dashed #ccc;
Â  Â  Â  color: #444;
Â  Â  Â  font-style: italic;
Â  Â  Â  font-size: 0.9em;
Â  Â  }
Â  Â  .notes.show { display: block; }
Â  Â  .rating-stars {
Â  Â  Â  color: #f5b301;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  letter-spacing: 1px;
Â  Â  }
Â  Â  .initial-prompt {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-top: 50px;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  color: #777;
Â  Â  }
Â  Â  .platform-icon {
Â  Â  Â  display: inline-block;
Â  Â  Â  width: 16px;
Â  Â  Â  height: 16px;
Â  Â  Â  margin-left: 4px;
Â  Â  Â  vertical-align: middle;
Â  Â  Â  background-size: cover;
Â  Â  }
Â  Â  .icon-Netflix { background-color: #E50914; border-radius: 2px; }
Â  Â  .icon-Prime { background-color: #00A8E1; border-radius: 2px; }
Â  Â  .icon-YouTube { background-color: #FF0000; border-radius: 2px; }
Â  Â  .icon-Apple { background-color: #555; border-radius: 50%; }
Â  Â  .icon-TVNZ { background-color: #0057B8; border-radius: 2px; }
Â  Â  .icon-Neon { background-color: #8A2BE2; border-radius: 2px; }
Â  Â  .icon-Beamafilm { background-color: #FF6600; border-radius: 2px; }
Â  Â  .icon-AroVision { background-color: #006400; border-radius: 2px; }
Â  Â  .icon-Plex { background-color: #E5A00D; border-radius: 2px; }
Â  Â  .icon-MUBI { background-color: #000; border-radius: 2px; }
Â  Â  .icon-Disney { background-color: #113CCF; border-radius: 2px; }
Â  Â  .icon-Microsoft { background-color: #F25022; border-radius: 2px; }
Â  Â  .icon-Google { background-color: #4285F4; border-radius: 2px; }
Â  Â  .icon-Archive { background-color: #666; border-radius: 2px; }
Â  Â  .icon-DVD { background-color: #999; border-radius: 2px; }
Â  Â  .watched-status-icon {
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  color: #0d6efd;
Â  Â  Â  margin-left: 5px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .notes-indicator {
Â  Â  Â  font-size: 1em;
Â  Â  Â  color: #4CAF50;
Â  Â  Â  margin-left: 5px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: help;
Â  Â  }
Â  Â  .pin-icon {
Â  Â  Â  font-size: 1em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  vertical-align: middle;
Â  Â  Â  margin-left: 10px;
Â  Â  }
Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  .timeline-event {
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  left: 0 !important;
Â  Â  Â  Â  margin: 0 auto 20px;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <details class="timeline-legend">
Â  Â  <summary>Timeline Legend</summary>
Â  Â  <div class="legend-content">
Â  Â  Â  <div class="legend-group">
Â  Â  Â  Â  <h3>Classification Color</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <tr><td class="legend-box classification-Documentary"></td><td><strong>Documentary</strong> (Solid Green line)</td></tr>
Â  Â  Â  Â  Â  <tr><td class="legend-box classification-Dramatisation"></td><td><strong>Dramatisation</strong> (Solid Amber line)</td></tr>
Â  Â  Â  Â  Â  <tr><td class="legend-box classification-Fiction"></td><td><strong>Fiction</strong> (Solid Red line)</td></tr>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <div class="legend-group">
Â  Â  Â  Â  <h3>Historical Accuracy Rating</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <tr><td><span class="rating-stars">â˜…â˜…â˜…â˜…â˜…</span></td><td>Highly accurate, closely follows historical records with minimal dramatization.</td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="rating-stars">â˜…â˜…â˜…â˜…â˜†</span></td><td>Mostly accurate, with some dramatized elements or composite characters.</td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="rating-stars">â˜…â˜…â˜…â˜†â˜†</span></td><td>Balanced mix of fact and fiction; key events are real but heavily dramatized.</td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="rating-stars">â˜…â˜…â˜†â˜†â˜†</span></td><td>Loosely based on history; significant liberties taken.</td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="rating-stars">â˜…â˜†â˜†â˜†â˜†</span></td><td>Fictional story with minimal historical grounding.</td></tr>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <h3>Platform/s</h3>
Â  Â  Â  <table>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Netflix"></span></td><td>Netflix</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Prime"></span></td><td>Prime Video</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-YouTube"></span></td><td>YouTube</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Apple"></span></td><td>Apple TV</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-TVNZ"></span></td><td>TVNZ</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Neon"></span></td><td>Neon</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Beamafilm"></span></td><td>Beamafilm</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-AroVision"></span></td><td>AroVision</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Plex"></span></td><td>Plex</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-MUBI"></span></td><td>MUBI</td></tr>
Â  Â  Â  Â  <tr><td><span class="platform-icon icon-Disney"></span></td><td>Disney+</td></tr>
Â  Â  Â  </table>
Â  Â  Â  <div class="legend-group">
Â  Â  Â  Â  <h3>Other Symbols</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <tr><td><span class="watched-status-icon">âœ”</span></td><td>Film has been <strong>Watched</strong></td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="notes-indicator">&#9999;</span></td><td>Film has <strong>Notes</strong> (Click card to view)</td></tr>
Â  Â  Â  Â  Â  <tr><td><span class="pin-icon">ğŸ“Œ</span></td><td>Film is <strong>Pinned</strong> as a favorite</td></tr>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </details>
Â  <details class="config-panel">
Â  Â  <summary>Config</summary>
Â  Â  <div class="controls">
Â  Â  Â  <label><input type="checkbox" id="hideWatchedToggle"> Hide Watched Films</label>
Â  Â  Â  <label><input type="checkbox" id="hidePinnedToggle"> Hide Pinned Films</label>
Â  Â  Â  <label><input type="checkbox" id="challengeModeToggle"> Challenge Mode (Unwatched + Unpinned)</label>
Â  Â  </div>
Â  </details>

Â  <details class="filter-panel">
Â  Â  <summary>Filter Options</summary>
Â  Â  <div class="controls">
Â  Â  Â  <input type="text" id="searchInput" placeholder="Search..." disabled>
Â  Â  Â  <select id="watchedFilter" disabled>
Â  Â  Â  Â  <option value="">Watched: All</option>
Â  Â  Â  Â  <option value="Yes">Watched: Yes</option>
Â  Â  Â  Â  <option value="No">Watched: No</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="formatFilter" disabled>
Â  Â  Â  Â  <option value="">Format: All</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="classificationFilter" disabled>
Â  Â  Â  Â  <option value="">Classification: All</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="platformFilter" disabled>
Â  Â  Â  Â  <option value="">Platform/s: All</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="eventYearFilter" disabled>
Â  Â  Â  Â  <option value="">Event Year: All</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="periodFilter" disabled>
Â  Â  Â  Â  <option value="">Period: All</option>
Â  Â  Â  </select>
Â  Â  Â  <select id="pinnedFilter" disabled>
Â  Â  Â  Â  <option value="">Pinned: All</option>
Â  Â  Â  Â  <option value="Yes">Pinned: Yes</option>
Â  Â  Â  Â  <option value="No">Pinned: No</option>
Â  Â  Â  </select>
Â  Â  Â  <button id="clearFilters" disabled>Clear Filters</button>
Â  Â  </div>
Â  </details>
<details class="stats-panel">
Â  <summary>Stats</summary>
Â  <div class="controls" id="statsContent"></div> </details>

Â  <div class="timeline" id="timeline">
Â  Â  <div class="initial-prompt" id="initialPrompt">Loading data...</div>
Â  </div>
<script>
  let data = [];

  const searchInput = document.getElementById('searchInput');
  const watchedFilter = document.getElementById('watchedFilter');
  const formatFilter = document.getElementById('formatFilter');
  const classificationFilter = document.getElementById('classificationFilter');
  const platformFilter = document.getElementById('platformFilter');
  const eventYearFilter = document.getElementById('eventYearFilter');
  const periodFilter = document.getElementById('periodFilter');
  const pinnedFilter = document.getElementById('pinnedFilter');
  const clearFilters = document.getElementById('clearFilters');
  const timelineContainer = document.getElementById('timeline');
  const initialPrompt = document.getElementById('initialPrompt');
  const hideWatchedToggle = document.getElementById("hideWatchedToggle");
  const hidePinnedToggle = document.getElementById("hidePinnedToggle");
  const challengeModeToggle = document.getElementById("challengeModeToggle");
  // ğŸ“Š Stats panel
  const statsContent = document.getElementById("statsContent");
  
  function getPlatformIcons(watchOnText) {
    if (!watchOnText) return '';
    const platformMap = {
      netflix: 'Netflix', prime: 'Prime', youtube: 'YouTube', apple: 'Apple',
      tvnz: 'TVNZ', tvnzplus: 'TVNZ', neon: 'Neon', beamafilm: 'Beamafilm',
      arovision: 'AroVision', plex: 'Plex', mubi: 'MUBI', disney: 'Disney',
      microsoft: 'Microsoft', google: 'Google', archive: 'Archive', dvd: 'DVD'
    };
    const seen = new Set();
    const icons = [];
    watchOnText.split(',').forEach(entry => {
      const clean = entry.trim().toLowerCase().replace(/[^a-z0-9+]/gi, '');
      for (const key in platformMap) {
        if (clean.includes(key) && !seen.has(key)) {
          seen.add(key);
          icons.push(`<span class="platform-icon icon-${platformMap[key]}" title="Available on ${platformMap[key]}"></span>`);
          break;
        }
      }
    });
    return icons.join('');
  }

  function renderStars(value) {
    const match = String(value).match(/^([1-5])\/5$/);
    if (!match) return "";
    const score = parseInt(match[1]);
    return `<span class="rating-stars">${"â˜…".repeat(score)}${"â˜†".repeat(5 - score)}</span>`;
  }

  function toggleControls(enable) {
    [searchInput, watchedFilter, formatFilter, classificationFilter, platformFilter, eventYearFilter, periodFilter, pinnedFilter, clearFilters].forEach(el => {
      el.disabled = !enable;
    });
  }

  function populateDropdowns(fullData) {
    const formats = [...new Set(fullData.map(f => f.Format).filter(Boolean))].sort();
    const classifications = [...new Set(fullData.map(f => f.Classification).filter(Boolean))].sort();
    const platforms = [...new Set(fullData.flatMap(f => f.WatchOn?.split(',').map(p => p.trim()) || []))].sort();
    const eventYears = [...new Set(fullData.map(f => f.EventYear).filter(Boolean))].sort();
    const periods = [...new Set(fullData.map(f => f.Period).filter(Boolean))].sort();

    formatFilter.innerHTML = '<option value="">Format: All</option>' + formats.map(f => `<option value="${f}">${f}</option>`).join("");
    classificationFilter.innerHTML = '<option value="">Classification: All</option>' + classifications.map(c => `<option value="${c}">${c}</option>`).join("");
    platformFilter.innerHTML = '<option value="">Platform/s: All</option>' + platforms.map(p => `<option value="${p}">${p}</option>`).join("");
    eventYearFilter.innerHTML = '<option value="">Event Year: All</option>' + eventYears.map(y => `<option value="${y}">${y}</option>`).join("");
    periodFilter.innerHTML = '<option value="">Period: All</option>' + periods.map(p => `<option value="${p}">${p}</option>`).join("");
  }

  function parseSearchQuery(query) {
    const terms = query.toLowerCase().split(/\s+/);
    const filters = {};
    const keywords = [];
  
    terms.forEach(term => {
      const [field, value] = term.split(":");
      if (value && ["title", "platform", "classification", "period", "year", "watched"].includes(field)) {
        filters[field] = value;
      } else {
        keywords.push(term);
      }
    });
  
    return { filters, keywords };
  }

  
  function applyFilters() {
    const rawQuery = searchInput.value.trim();
    const { filters, keywords } = parseSearchQuery(rawQuery);
  
    const watched = watchedFilter.value;
    const format = formatFilter.value;
    const classification = classificationFilter.value;
    const platform = platformFilter.value;
    const eventYear = eventYearFilter.value;
    const period = periodFilter.value;
    const pinned = pinnedFilter.value;
  
    const hideWatched = hideWatchedToggle?.checked;
    const hidePinned = hidePinnedToggle?.checked;
    const challengeMode = challengeModeToggle?.checked;
  
    const filtered = data.filter(film => {
      const text = Object.values(film).join(" ").toLowerCase();
  
      if (keywords.length && !keywords.every(k => text.includes(k))) return false;
  
      if (filters.title && !(film.FilmTitle || "").toLowerCase().includes(filters.title)) return false;
      if (filters.platform && !(film.WatchOn || "").toLowerCase().includes(filters.platform)) return false;
      if (filters.classification && !(film.Classification || "").toLowerCase().includes(filters.classification)) return false;
      if (filters.period && !(film.Period || "").toLowerCase().includes(filters.period)) return false;
      if (filters.year && String(film.EventYear || "").trim() !== filters.year.trim()) return false;
      if (filters.watched && String(film.Watched || "").toLowerCase() !== filters.watched) return false;
  
      if (watched && film.Watched !== watched) return false;
      if (format && film.Format !== format) return false;
      if (classification && film.Classification !== classification) return false;
      if (platform && !(film.WatchOn || "").toLowerCase().includes(platform.toLowerCase())) return false;
      if (eventYear && String(film.EventYear || "").trim() !== eventYear.trim()) return false;
      if (period && film.Period !== period) return false;
      if (pinned === "Yes" && !film.Pinned) return false;
      if (pinned === "No" && film.Pinned) return false;
  
      if (hideWatched && film.Watched === "Yes") return false;
      if (hidePinned && film.Pinned) return false;
      if (challengeMode && (film.Watched === "Yes" || film.Pinned)) return false;
  
      return true;
    });
  
    renderTimeline(filtered);
    updateStats(filtered);
  }


  function renderTimeline(filteredData) {
    timelineContainer.innerHTML = "";
    if (filteredData.length === 0) {
      timelineContainer.appendChild(initialPrompt);
      initialPrompt.style.display = 'block';
      initialPrompt.textContent = "No data found or all records filtered out.";
      return;
    }

    initialPrompt.style.display = 'none';
    const grouped = {};

    filteredData.forEach(film => {
      let year = "Unknown Year";
      const rawYear = String(film.EventYear || "").trim();
      if (/^\d{4}$/.test(rawYear)) {
        year = rawYear;
      } else if (rawYear.includes('â€“') || rawYear.includes('-')) {
        year = rawYear.split(/[â€“-]/)[0].trim();
      } else if (rawYear) {
        year = rawYear.split(' ')[0];
      }
      if (!grouped[year]) grouped[year] = [];
      grouped[year].push(film);
    });

    const sortedYears = Object.keys(grouped).sort((a, b) => {
      if (a === "Unknown Year") return 1;
      if (b === "Unknown Year") return -1;
      return parseInt(a) - parseInt(b);
    });

    sortedYears.forEach(year => {
      const filmsInYear = grouped[year];
      const yearGroup = document.createElement("div");
      yearGroup.className = "year-group";

      const yearMarker = document.createElement("div");
      yearMarker.className = "year-marker";
      yearMarker.textContent = year;
      yearGroup.appendChild(yearMarker);

      filmsInYear.forEach((film, index) => {
        const event = document.createElement("div");
        event.className = `timeline-event ${index % 2 === 0 ? "left" : "right"}`;
        if (film.Classification) {
          event.classList.add(`classification-${String(film.Classification).split('/')[0].trim().replace(/\s/g, '-')}`);
        }
        if (film.Pinned) {
          event.classList.add("pinned");
        }

        const watchedStatus = film.Watched && String(film.Watched).toLowerCase() === 'yes'
          ? `Yes <span class="watched-status-icon" title="You have watched this film.">âœ”</span>`
          : (film.Watched || "No");

        let notesIndicator = film.Notes ? `<span class="notes-indicator" title="Click to view notes!">&#9999;</span>` : '';
        let imageHTML = film.ImageURL ? `<img src="${film.ImageURL}" alt="Poster for ${film.FilmTitle}" class="event-image">` : '';

        const title = document.createElement("div");
        title.className = "event-title";
        title.innerHTML = `
          ${imageHTML}${film.FilmTitle}${film.ReleaseYear ? `<span style="font-weight: normal;"> (${film.ReleaseYear})</span>` : ""}
          ${notesIndicator}
        `;
        event.appendChild(title);

        const details = document.createElement("div");
        details.className = "event-details";
        details.innerHTML = `
          <b>Period:</b> ${film.Period || ""}<br>
          <b>Format:</b> ${film.Format || ""}<br>
          <b>Classification:</b> ${film.Classification || ""}<br>
          <b>Running Time:</b> ${film.RunningTime || ""}<br>
          <b>Historical Accuracy:</b> ${renderStars(film.HistoricalAccuracy)}<br>
          <b>Short Description:</b> ${film.ShortDescription || ""}<br>
          <b>Watch On:</b> ${film.WatchOn || ""} ${getPlatformIcons(film.WatchOn)}<br>
          <b>Link:</b> ${film.Link ? `<a href="${film.Link}" target="_blank">View Link</a>` : ""}<br>
          <b>Watched:</b> ${watchedStatus}
          <b>Rating:</b> ${renderStars(film.Rating || 0)}
          <span class="pin-icon" title="Click to pin/unpin this film" style="margin-left: 10px; font-size: 1em; vertical-align: middle; cursor: pointer;">
            ${film.Pinned ? "ğŸ“Œ" : "ğŸ“"}
          </span>
        `;
        event.appendChild(details);

        const pinSpan = details.querySelector(".pin-icon");
        pinSpan.addEventListener("click", (e) => {
          e.stopPropagation();
          film.Pinned = !film.Pinned;
          applyFilters();
        });

        if (film.Notes) {
          const notes = document.createElement("div");
          notes.className = "notes";
          notes.textContent = `Notes: ${film.Notes}`;
          event.appendChild(notes);
          event.addEventListener("click", (e) => {
            if (e.target.tagName !== 'A') {
              notes.classList.toggle("show");
            }
          });
        }

        yearGroup.appendChild(event);
      });

      timelineContainer.appendChild(yearGroup);
    });
  }
  
  function updateStats(filteredData) {
    const total = filteredData.length;
    const byClassification = {};
    const watchedCount = filteredData.filter(f => f.Watched === "Yes").length;
    const pinnedCount = filteredData.filter(f => f.Pinned).length;
  
    filteredData.forEach(f => {
      const key = f.Classification || "Unclassified";
      byClassification[key] = (byClassification[key] || 0) + 1;
    });
  
    const topPlatforms = {};
    filteredData.forEach(f => {
      (f.WatchOn || "").split(",").forEach(p => {
        const key = p.trim();
        if (key) topPlatforms[key] = (topPlatforms[key] || 0) + 1;
      });
    });
  
    const topPlatformList = Object.entries(topPlatforms)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([p, count]) => `${p} (${count})`)
      .join(", ");
  
    statsContent.innerHTML = `
      <b>Total Films:</b> ${total}<br>
      <b>Watched:</b> ${watchedCount}<br>
      <b>Pinned:</b> ${pinnedCount}<br>
      <b>By Classification:</b><br>
      ${Object.entries(byClassification).map(([k, v]) => `&nbsp;&nbsp;${k}: ${v}`).join("<br>")}
      <br><b>Top Platforms:</b> ${topPlatformList}
    `;
  }
  
  async function fetchAndRenderData() {
    initialPrompt.textContent = "Loading data via Web App...";
    try {
      const response = await fetch("https://script.google.com/macros/s/AKfycbwuMhkWNZI71HWbZr18pe56ekjCVrn0SCliiFHOzIW60odC3CsOstRgUeMIEbg03xbeNA/exec");
      const sheetData = await response.json();
      data = sheetData;
      populateDropdowns(data);
      toggleControls(true);
      applyFilters();        // âœ… Apply filters and render timeline
      updateStats(data);     // âœ… Populate stats immediately
    } catch (error) {
      console.error("Fetch error:", error);
      initialPrompt.textContent = `ERROR: Failed to load data. ${error.message}`;
      toggleControls(false);
    }
  }

  toggleControls(false);
  renderTimeline([]);
  fetchAndRenderData();

  clearFilters.addEventListener("click", () => {
    searchInput.value = "";
    watchedFilter.value = "";
    formatFilter.value = "";
    classificationFilter.value = "";
    platformFilter.value = "";
    eventYearFilter.value = "";
    periodFilter.value = "";
    pinnedFilter.value = "";
    applyFilters();
  });

  searchInput.addEventListener("input", applyFilters);
  watchedFilter.addEventListener("change", applyFilters);
  formatFilter.addEventListener("change", applyFilters);
  classificationFilter.addEventListener("change", applyFilters);
  platformFilter.addEventListener("change", applyFilters);
  eventYearFilter.addEventListener("change", applyFilters);
  periodFilter.addEventListener("change", applyFilters);
  pinnedFilter.addEventListener("change", applyFilters);
  [hideWatchedToggle, hidePinnedToggle, challengeModeToggle].forEach(el => {
    el?.addEventListener("change", applyFilters);
  });
  
</script>
</body>
</html>
